# ansible_keycloak_smallstep

## Description
This project is aimed at configuring Keycloak with a web application. The SSL certificates are generated by Smallstep, and the configuration is performed using Ansible.

## Getting started
This project requires `ansible`, `ansible-playbook`, `docker` and `docker-compose` installed.

## Installation and running
From the root directory:

`docker-compose up -d`

Once the containers are all running, run:

`ansible-playbook -i ./ansible/inventory ./ansible/playbook -v`

The playbook initialises the containers with the correct SSL certificates. 
The playbook is not idempotent - once the playbook is run once, the certificates cannot be re-generated using the same containers/playbook.
The containers need to be torn down and destroyed using `docker-compose down`, then re-scaffolded using `docker-compose up` before the playbook can be re-run.

Keycloak is brought up via a separate docker-compose file, to allow the container to be initialised with the created certificates. Keycloak takes some time to initialise, so the logs of the container should be checked to determine status.
Once the KC instance is brought up and fully initialised, there should be a log in the container reading:
` [org.keycloak.quarkus.runtime.KeycloakMain] (main) Running the server in development mode. DO NOT use this configuration in production.`

At this point, the console should be accessible via https://localhost. In all likelihood an exception for the certificate will need to be added to the browser to access the console.
This could probably be avoided by extracting the Smallstep root CA certificate out of the certificate_generator container and installing it on the host machine. However, this has not been included.

The dotnet app should also be accessible via https://localhost:5001, using the certificate configured via Ansible and issued via the local Smallstep CA.

Because the login flow is executed in a browser outside of the docker-compose network, the hosts file of the machine on which the project is run needs to be updated. An example snippet is shown below:

```
# development
127.0.0.1 whoami.example
127.0.0.1 dotnet.example
127.0.0.1 pgadmin.example
127.0.0.1 keycloak.example
127.0.0.1 keycloak
```